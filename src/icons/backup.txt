import pygame
from models.construction import ConstructionMode
from config.colors import RED, YELLOW, WHITE, GRAY
from config.paths import CONSTRUCTION_MODE_ICONS
from config.settings import CONSTRUCTION_BUTTON_SIZE


def get_zoom_box(surface: pygame.Surface) -> pygame.Rect:
    return pygame.Rect(surface.get_width() - 100, 10, 80, 30)


def load_construction_icons():
    icon_cache = {}
    for mode in ConstructionMode:
        icon_path = CONSTRUCTION_MODE_ICONS[mode.name]
        icon = pygame.image.load(icon_path).convert_alpha()
        # Convert icon to white while preserving alpha, except for PLATFORM: invert colors
        if mode.name == "PLATFORM":
            colored_icon = pygame.Surface(icon.get_size(), pygame.SRCALPHA)
            for x in range(icon.get_width()):
                for y in range(icon.get_height()):
                    r, g, b, a = icon.get_at((x, y))
                    inv_color = (255 - r, 255 - g, 255 - b, a)
                    colored_icon.set_at((x, y), inv_color)
            # Draw a white border around the icon
            border_rect = colored_icon.get_rect()
            pygame.draw.rect(colored_icon, (255, 255, 255), border_rect, 2)
        else:
            color = (255, 255, 255)
            colored_icon = pygame.Surface(icon.get_size(), pygame.SRCALPHA)
            colored_icon.fill((*color, 0))
            for x in range(icon.get_width()):
                for y in range(icon.get_height()):
                    _, _, _, alpha = icon.get_at((x, y))
                    colored_icon.set_at((x, y), (*color, alpha))
        # Scale icon to fit button with some padding
        colored_icon = pygame.transform.scale(colored_icon, (CONSTRUCTION_BUTTON_SIZE, CONSTRUCTION_BUTTON_SIZE))
        icon_cache[mode] = colored_icon
    return icon_cache

def get_construction_buttons(surface: pygame.Surface) -> list[tuple[ConstructionMode, pygame.Rect]]:
    button_size = 50
    button_margin = 10
    w, h = surface.get_size()
    buttons = []
    for i, mode in enumerate(ConstructionMode):
        rect = pygame.Rect(
            button_margin + i * (button_size + button_margin),
            h - button_size - button_margin,
            button_size,
            button_size
        )
        buttons.append((mode, rect))
    return buttons


def draw_construction_buttons(surface, mode: ConstructionMode, icon_cache):
    buttons = get_construction_buttons(surface)
    for m, btn_rect in buttons:
        if m == mode:
            border_color = YELLOW
            border_width = 4
        else:
            border_color = GRAY
            border_width = 2
        pygame.draw.rect(surface, border_color, btn_rect, border_width, border_radius=8)
        icon = icon_cache[m]
        icon_rect = icon.get_rect(center=btn_rect.center)
        surface.blit(icon, icon_rect)


def draw_zoom_indicator(surface, camera):
    if camera.scale != 1.0 or camera.x != 0 or camera.y != 0:
        zoom_text = f"{int(camera.scale * 100)}%"
        zoom_font = pygame.font.SysFont(None, 24)
        zoom_surface = zoom_font.render(zoom_text, True, WHITE)
        zoom_box = get_zoom_box(surface)
        pygame.draw.rect(surface, (50, 50, 50), zoom_box, border_radius=4)
        pygame.draw.rect(surface, (150, 150, 150), zoom_box, 2, border_radius=4)
        surface.blit(zoom_surface, zoom_surface.get_rect(center=zoom_box.center))
